<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导航守卫 Navigation Guards</title>
    <link rel="stylesheet" href="../css/common.css">
    <base target="_blank">
</head>

<body>
    <header>
        <h1>导航守卫</h1>
        <span>&commat; Navigation Guards</span>
    </header>
    <dl>
        <dd>控制路由的访问权限，如：未登录，不可以下单、发帖、留言或领取优惠券，通常会引导用户到特定页面，如登录页面</dd>
        <dt>导航解析流程</dt>
        <dd class="sn">
            <div>导航被触发</div>
            <div>在失活的组件里调用 beforeRouteLeave 守卫</div>
            <div>调用全局的 beforeEach 守卫</div>
            <div>在重用的组件里调用 beforeRouteUpdate 守卫(2.2+)</div>
            <div>在路由配置里调用 beforeEnter</div>
            <div>解析异步路由组件</div>
            <div>在被激活的组件里调用 beforeRouteEnter</div>
            <div>调用全局的 beforeResolve 守卫(2.5+)</div>
            <div>导航被确认</div>
            <div>调用全局的 afterEach 钩子</div>
            <div>触发 DOM 更新</div>
            <div>调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入</div>
        </dd>
        <dt>全局前置守卫 beforeEach(fn) </dt>
        <dd>使用 router.beforeEach 注册一个全局前置守卫，执行函数 fn，接收3个参数：</dd>
        <dd>to：进入的路由</dd>
        <dd>from：离开的路由</dd>
        <dd>next()：是一个函数，表示是否允许，实现路由控制，如：未登录不允许访问，并引导|重定向到指定页面</dd>
        <dd class="sn">
            <div>正常访问；或不使用 next 形参</div>
            <pre>
router.beforeEach((to, from, next) => {
    next()
})</pre>
            <div>不允许访问 - 简单粗暴；不建议直接使用</div>
            <pre>
router.beforeEach((to, from, next) => {
    if(to.path=='/order')
        next(false)
})</pre>
            <div>在next()中指定跳转的路由，引导到指定页面 - 建议</div>
            <pre>
router.beforeEach((to, from, next) => {
    if (to.path == '/order') {
        //next('/home')
        //next({ path: '/home' })
        next({ name: 'home' })
    } else {
        next()
    }
})</pre>
            <div>如果使用了 next()，但是不执行，则不会跳转，也就不会执行全局后置钩子 afterEach()</div>
        <dd>
            <pre>
router.beforeEach((to, from, next) => {
    console.log('hi');    
})</pre>
        </dd>
        <dt>全局后置钩子 afterEach(fn)</dt>
        <dd>使用 router.afterEach 注册一个全局后置守卫，执行函数 fn，接收2个参数：to、from</dd>
        <dd>不接受 next 函数也不会改变导航本身，因为导航已结束</dd>
        <dd>
            <pre>
router.afterEach((to, from) => {
    //
})</pre>
        </dd>
        <dt>全局解析守卫 beforeResolve(fn)</dt>
        <dd>使用 router.beforeResolve 注册一个全局解析守卫</dd>
        <dt>路由独享的守卫</dt>
        <dd>局部路由使用守卫</dd>
        <dd class="example-sn"><a href="./drill_menu.html">实操 - 汉堡菜单</a></dd>
        <dd>在路由文件中，引入仓库 menu.js</dd>
        <dd>每次进入，创建菜单实例并设置菜单栏样式为隐藏；也可以创建该仓库的全局仓库</dd>
        <dd>导航守卫运行在 Vue 应用初始化的早期阶段，此时可能还未创建或注入 Pinia store 实例</dd>
        <dd>
            <pre>
import { useMenuStore } from '@/stores/menu'

router.beforeEach((to, from, next) => {
    // 其它逻辑

    const store = useMenuStore();
    store.flag = false;
    next();
})

router.afterEach((to, from) => {
    // 其它逻辑

    if (to.path === from.path) {
        const store = useMenuStore()
        store.flag = false
    }
})</pre>
        </dd>
        <dd class="example-sn">导航结束后，设置页面标题 title；需要为路由配置 meta 属性</dd>
        <dd>
            <pre>
router.afterEach((to, from) => {
    document.title = to.meta.title
})</pre>
        </dd>
        <dd class="example-sn">添加页面 <a href="../node/dependency.html">NProgress - 进度条</a> 特效 - 导航前开始，导航后结束</dd>
        <dd>
            <pre>
router.beforeEach((to, from, next) => {
    NProgress.start();
    next()
})
    
router.afterEach((to, from) => {
    NProgress.done();
})
            </pre>
        </dd>
        <dd class="example-sn">登录认证 - 借助登录 token 或本地存储的登录信息实现路由控制</dd>
        <dd>
            <pre>
router.beforeEach((to, from, next) => {
    console.log('hi');
    let token = localStorage.getItem('token')
    if (to.path == '/order' && !token) {
        next('/login')
    } else {
        next()
    }
})</pre>
        </dd>
        <dd class="tips">
            <div>更多路由控制，应由后端服务器实现，前端不可靠</div>
            <div>路由配置时，如果不是每个路由都指定 meta，使用时应先判断再使用</div>
        </dd>
    </dl>
    <iframe src="../common/footer.html" frameborder="0" scrolling="no" title="footer" id="footer"></iframe>
    <script src="../utils/custom/clipboard.js"></script>
</body>

</html>